<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `determinator` crate."><meta name="keywords" content="rust, rustlang, rust-lang, determinator"><title>determinator - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../ayu.css" disabled ><script src="../storage.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="icon" type="image/svg+xml" href="../favicon.svg">
<link rel="alternate icon" type="image/png" href="../favicon-16x16.png">
<link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../determinator/index.html'><div class='logo-container rust-logo'><img src='../rust-logo.png' alt='logo'></div></a><p class='location'>Crate determinator</p><div class='block version'><p>Version 0.1.1</p></div><div class="sidebar-elems"><a id='all-types' href='all.html'><p>See all determinator's items</p></a><div class="block items"><ul><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li></ul></div><p class='location'></p><script>window.sidebarCurrent = {name: 'determinator', ty: 'mod', relpath: '../'};</script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><span class="help-button">?</span>
                <a id="settings-menu" href="../settings.html"><img src="../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class='fqn'><span class='out-of-band'><span id='render-detail'><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class='inner'>&#x2212;</span>]</a></span><a class='srclink' href='../src/determinator/lib.rs.html#4-249' title='goto source code'>[src]</a></span><span class='in-band'>Crate <a class="mod" href=''>determinator</a></span></h1><div class='docblock'><p>Figure out what packages in a Rust workspace changed between two commits.</p>
<p>A typical continuous integration system runs every build and every test on every pull request or
proposed change. In large monorepos, most proposed changes have no effect on most packages. A
<em>target determinator</em> decides, given a proposed change, which packages may have had changes
to them.</p>
<p>The determinator is desiged to be used in the
<a href="https://github.com/diem/diem">Diem Core workspace</a>, which is one such monorepo.</p>
<h1 id="examples" class="section-header"><a href="#examples">Examples</a></h1>
<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">use</span> <span class="ident">determinator</span>::{<span class="ident">Determinator</span>, <span class="ident">rules</span>::<span class="ident">DeterminatorRules</span>};
<span class="kw">use</span> <span class="ident">guppy</span>::{<span class="ident">CargoMetadata</span>, <span class="ident">graph</span>::<span class="ident">DependencyDirection</span>};
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">path</span>::<span class="ident">Path</span>;

<span class="comment">// guppy accepts `cargo metadata` JSON output. Use a pre-existing fixture for these examples.</span>
<span class="kw">let</span> <span class="ident">old_metadata</span> <span class="op">=</span> <span class="ident">CargoMetadata</span>::<span class="ident">parse_json</span>(<span class="macro">include_str</span><span class="macro">!</span>(<span class="string">&quot;../../../fixtures/guppy/metadata_guppy_78cb7e8.json&quot;</span>)).<span class="ident">unwrap</span>();
<span class="kw">let</span> <span class="ident">old</span> <span class="op">=</span> <span class="ident">old_metadata</span>.<span class="ident">build_graph</span>().<span class="ident">unwrap</span>();
<span class="kw">let</span> <span class="ident">new_metadata</span> <span class="op">=</span> <span class="ident">CargoMetadata</span>::<span class="ident">parse_json</span>(<span class="macro">include_str</span><span class="macro">!</span>(<span class="string">&quot;../../../fixtures/guppy/metadata_guppy_869476c.json&quot;</span>)).<span class="ident">unwrap</span>();
<span class="kw">let</span> <span class="ident">new</span> <span class="op">=</span> <span class="ident">new_metadata</span>.<span class="ident">build_graph</span>().<span class="ident">unwrap</span>();

<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">determinator</span> <span class="op">=</span> <span class="ident">Determinator</span>::<span class="ident">new</span>(<span class="kw-2">&amp;</span><span class="ident">old</span>, <span class="kw-2">&amp;</span><span class="ident">new</span>);

<span class="comment">// The determinator supports custom rules read from a TOML file.</span>
<span class="kw">let</span> <span class="ident">rules</span> <span class="op">=</span> <span class="ident">DeterminatorRules</span>::<span class="ident">parse</span>(<span class="macro">include_str</span><span class="macro">!</span>(<span class="string">&quot;../../../fixtures/guppy/path-rules.toml&quot;</span>)).<span class="ident">unwrap</span>();
<span class="ident">determinator</span>.<span class="ident">set_rules</span>(<span class="kw-2">&amp;</span><span class="ident">rules</span>).<span class="ident">unwrap</span>();

<span class="comment">// The determinator expects a list of changed files to be passed in.</span>
<span class="ident">determinator</span>.<span class="ident">add_changed_paths</span>(<span class="macro">vec</span><span class="macro">!</span>[<span class="ident">Path</span>::<span class="ident">new</span>(<span class="string">&quot;guppy/src/lib.rs&quot;</span>), <span class="ident">Path</span>::<span class="ident">new</span>(<span class="string">&quot;tools/determinator/README.md&quot;</span>)]);

<span class="kw">let</span> <span class="ident">determinator_set</span> <span class="op">=</span> <span class="ident">determinator</span>.<span class="ident">compute</span>();
<span class="comment">// determinator_set.affected_set contains the workspace packages directly or indirectly affected</span>
<span class="comment">// by the change.</span>
<span class="kw">for</span> <span class="ident">package</span> <span class="kw">in</span> <span class="ident">determinator_set</span>.<span class="ident">affected_set</span>.<span class="ident">packages</span>(<span class="ident">DependencyDirection</span>::<span class="ident">Forward</span>) {
    <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;affected: {}&quot;</span>, <span class="ident">package</span>.<span class="ident">name</span>());
}</pre></div>
<h1 id="how-it-works" class="section-header"><a href="#how-it-works">How it works</a></h1>
<p>A Rust package can behave differently if one or more of the following change:</p>
<ul>
<li>The source code or <code>Cargo.toml</code> of the package.</li>
<li>A dependency.</li>
<li>The build or test environment.</li>
</ul>
<p>The determinator gathers data from several sources, and processes it through
<a href="https://docs.rs/guppy">guppy</a>, to figure out which packages need to be re-tested.</p>
<h2 id="file-changes" class="section-header"><a href="#file-changes">File changes</a></h2>
<p>The determinator takes as input a list of file changes between two revisions. For each
file provided:</p>
<ul>
<li>The determinator looks for the package nearest to the file and marks it as changed.</li>
<li>If the file is outside a package, the determinator assumes that everything needs to be
rebuilt.</li>
</ul>
<p>The list of file changes can be obtained from a source control system such as Git. This crate
provides a helper which simplifies the process of enumerating file lists while handling some
gnarly edge cases. For more information, see the documentation for <a href="../determinator/struct.Paths0.html"><code>Paths0</code></a>.</p>
<p>These simple rules may need to be customized for particular scenarios (e.g. to ignore certain
files, or mark a package changed if a file outside of it changes). For those situations, the
determinator lets you specify <em>custom rules</em>. See the
<a href="#customizing-behavior">Customizing behavior</a> section below for more.</p>
<h2 id="dependency-changes" class="section-header"><a href="#dependency-changes">Dependency changes</a></h2>
<p>A dependency is assumed to have changed if one or more of the following change:</p>
<ul>
<li>For a workspace dependency, its source code.</li>
<li>For a third-party dependency, its version or feature set.</li>
<li>Something in the environment that it depends on.</li>
</ul>
<p>The determinator runs Cargo build simulations on every package in the workspace. For each
package, the determinator figures out whether any of its dependencies (including feature sets)
have changed. These simulations are done with:</p>
<ul>
<li>dev-dependencies enabled (by default; this can be customized)</li>
<li>both the host and target platforms set to the current platform (by default; this can be
customized)</li>
<li>three sets of features for each package:
<ul>
<li>no features enabled</li>
<li>default features</li>
<li>all features enabled</li>
</ul>
</li>
</ul>
<p>If any of these simulated builds indicates that a workspace package has had any dependency
changes, then it is marked changed.</p>
<h2 id="environment-changes" class="section-header"><a href="#environment-changes">Environment changes</a></h2>
<p>The <em>environment</em> of a build or test run is anything not part of the source code that may
influence it. This includes but is not limited to:</p>
<ul>
<li>the version of the Rust compiler used</li>
<li>system libraries that a crate depends on</li>
<li>environment variables that a crate depends on</li>
<li>external services that a test depends on</li>
</ul>
<p><strong>By default, the determinator assumes that the environment stays the same between runs.</strong></p>
<p>To represent changes to the environment, you may need to find ways to represent those changes
as files checked into the repository, and add <a href="#customizing-behavior">custom rules</a> for them.
For example:</p>
<ul>
<li>Use a <a href="https://doc.rust-lang.org/edition-guide/rust-2018/rustup-for-managing-rust-versions.html#managing-versions"><code>rust-toolchain</code> file</a>
to represent the version of the Rust compiler. There is a default rule which causes a full
run if <code>rust-toolchain</code> changes.</li>
<li>Record all environment variables in CI configuration files, such as <a href="https://docs.github.com/en/free-pro-team@latest/actions/reference/workflow-syntax-for-github-actions">GitHub Actions workflow
files</a>,
and add a custom rule to do a full run if any of those files change.</li>
<li>As far as possible, make tests hermetic and not reach out to the network. If you only have a
few tests that make network calls, run them unconditionally.</li>
</ul>
<h1 id="customizing-behavior" class="section-header"><a href="#customizing-behavior">Customizing behavior</a></h1>
<p>The standard rules followed by the determinator may need to be tweaked in some situations:</p>
<ul>
<li>Some files should be ignored.</li>
<li>If some files or packages change, a full test run may be necessary.</li>
<li><em>Virtual dependencies</em> that Cargo isn't aware of may need to be inserted.</li>
</ul>
<p>For these situations, the determinator allows for custom <em>rules</em> to be specified. The
determinator also ships with
<a href="../determinator/rules/struct.DeterminatorRules.html#associatedconstant.DEFAULT_RULES_TOML">a default set of rules</a> for common files
like <code>.gitignore</code> and <code>rust-toolchain</code>.</p>
<p>For more about custom rules, see the documentation for the <a href="../determinator/rules/index.html"><code>rules</code> module</a>.</p>
<h1 id="limitations" class="section-header"><a href="#limitations">Limitations</a></h1>
<p>While the determinator can bring significant benefits to CI and local workflows, its model is
quite different from Cargo's. <strong>Please understand these limitations before using the
determinator for your project.</strong></p>
<p>For best results, consider doing occasional full runs in addition to determinator-based runs.
You may wish to configure your CI system to use the determinator for pull-requests, and also
schedule full runs every few hours on the main branch in case the determinator misses something.</p>
<h2 id="build-scripts-and-includeexclude-instructions" class="section-header"><a href="#build-scripts-and-includeexclude-instructions">Build scripts and include/exclude instructions</a></h2>
<p><strong>The determinator cannot run <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html">build scripts</a>.</strong>
The standard Cargo method for declaring a dependency on a file or environment variable is to
output <code>rerun-if-changed</code> or <code>rerun-if-env-changed</code> instructions in build scripts. These
instructions must be duplicated through custom rules.</p>
<p><strong>The determinator doesn't track the <a href="https://doc.rust-lang.org/cargo/reference/manifest.html#the-exclude-and-include-fields"><code>include</code> and <code>exclude</code> fields in <code>Cargo.toml</code></a>.</strong>
This is because the determinator's view of what's changed doesn't always align with these fields.
For example, packages typically include <code>README</code> files, but the determinator has a default rule
to ignore them.</p>
<p>If a package includes a file outside of it, either move it into the package (recommended) or
add a custom rule for it. Exclusions may be duplicated as custom rules that cause those files
to be ignored.</p>
<h2 id="path-dependencies-outside-the-workspace" class="section-header"><a href="#path-dependencies-outside-the-workspace">Path dependencies outside the workspace</a></h2>
<p><strong>The determinator may not be able to figure out changes to path dependencies outside the
workspace.</strong> The determinator relies on metadata to figure out whether a non-workspace
dependency has changed. The metadata includes:</p>
<ul>
<li>the version number</li>
<li>the source, such as <code>crates.io</code> or a revision in a Git repository</li>
</ul>
<p>This approach works for dependencies on <code>crates.io</code> or other package repositories, because a
change to their source code necessarily requires a version change.</p>
<p>This approach also works for <a href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#specifying-dependencies-from-git-repositories">Git
dependencies</a>.
It even works for Git dependencies that aren't pinned to an exact revision in <code>Cargo.toml</code>,
because <code>Cargo.lock</code> records exact revisions. For example:</p>
<pre><code class="language-toml"># Specifying this in Cargo.toml...
[dependencies]
rand = { git = &quot;https://github.com/rust-random/rand&quot;, branch = &quot;master&quot; }

# ...results in Cargo.lock with:
[[package]]
name = &quot;rand&quot;
version = &quot;0.7.4&quot;
source = &quot;git+https://github.com/rust-random/rand?branch=master#50c34064c80762ddae11447adc6240f42a6bd266&quot;
</code></pre>
<p>The hash at the end is the exact Git revision used, and a change to it is recognized by the
determinator.</p>
<p>Where this scheme may not work is with path dependencies, because the files on disk can change
without a version bump. <code>cargo build</code> can recognize those changes because it compares mtimes of
files on disk, but the determinator cannot do that.</p>
<p>This is not expected to be a problem for most projects that use workspaces. If
there's future demand, it would be possible to add support for changes to non-workspace path
dependencies if they're in the same repository.</p>
<h1 id="alternatives-and-tradeoffs" class="section-header"><a href="#alternatives-and-tradeoffs">Alternatives and tradeoffs</a></h1>
<p>One way to look at the determinator is as a kind of
<a href="https://martinfowler.com/bliki/TwoHardThings.html"><em>cache invalidation</em></a>. Viewed through this
lens, the main purpose of a build or test system is to cache results, and invalidate those
caches based on certain parameters. When the determinator marks a package as changed, it
invalidates any cached results for that package.</p>
<p>There are several other ways to design caching systems:</p>
<ul>
<li>The caching built into Cargo and other systems like GNU Make, which is based on file
modification times.</li>
<li><a href="https://github.com/mozilla/sccache">Mozilla's <code>sccache</code></a> and other &quot;bottom-up&quot; hash-based
caching build systems.</li>
<li><a href="https://bazel.build/">Bazel</a>, <a href="https://buck.build/">Buck</a> and other &quot;top-down&quot; hash-based
caching build systems.</li>
</ul>
<p>These other systems end up making different tradeoffs:</p>
<ul>
<li>Cargo can use build scripts to track file and environment changes over time. However, it
relies on a previous build being done on the same machine. Also, as of Rust 1.48, there is no
way to use Cargo caching for test results, only for builds.</li>
<li><code>sccache</code> <a href="https://github.com/mozilla/sccache#known-caveats">requires paths to be exact across machines</a>, and is unable to cache
<a href="https://github.com/mozilla/sccache/blob/master/docs/Rust.md">some kinds of Rust artifacts</a>. Also, just like Cargo's caching, there is no way
to use it for test results, only for builds.</li>
<li>Bazel and Buck have stringent requirements around the environment not affecting build results.
They're also not seamlessly integrated with Cargo.</li>
<li>The determinator works for both builds and tests, but cannot track file and environment
changes over time and must rely on custom rules. This scheme may produce both false negatives
and false positives.</li>
</ul>
<p>While the determinator is geared towards test runs, it also works for builds. If you wish to
use the determinator for build runs, consider stacking it with another layer of caching:</p>
<ul>
<li>Use the determinator as a first pass to filter out packages that haven't changed.</li>
<li>Then use a system like <code>sccache</code> to get hash-based caching for builds.</li>
</ul>
<h1 id="inspirations" class="section-header"><a href="#inspirations">Inspirations</a></h1>
<p>This determinator is inspired by, and shares its name with, the target determinator used in
Facebook's main source repository.</p>
</div><h2 id='modules' class='section-header'><a href="#modules">Modules</a></h2>
<table><tr class='module-item'><td><a class="mod" href="errors/index.html" title='determinator::errors mod'>errors</a></td><td class='docblock-short'><p>Error types returned by the determinator.</p>
</td></tr><tr class='module-item'><td><a class="mod" href="rules/index.html" title='determinator::rules mod'>rules</a></td><td class='docblock-short'><p>Custom rules for the target determinator.</p>
</td></tr></table><h2 id='structs' class='section-header'><a href="#structs">Structs</a></h2>
<table><tr class='module-item'><td><a class="struct" href="struct.Determinator.html" title='determinator::Determinator struct'>Determinator</a></td><td class='docblock-short'><p>Determine target dependencies from changed files and packages in a workspace.</p>
</td></tr><tr class='module-item'><td><a class="struct" href="struct.DeterminatorSet.html" title='determinator::DeterminatorSet struct'>DeterminatorSet</a></td><td class='docblock-short'><p>The result of a <code>Determinator</code> computation.</p>
</td></tr><tr class='module-item'><td><a class="struct" href="struct.Paths0.html" title='determinator::Paths0 struct'>Paths0</a></td><td class='docblock-short'><p>A store for null-separated paths.</p>
</td></tr></table></section><section id="search" class="content hidden"></section><section class="footer"></section><script>window.rootPath = "../";window.currentCrate = "determinator";</script><script src="../main.js"></script><script defer src="../search-index.js"></script></body></html>